---
title: "R Notebook"
output: html_notebook
---
```{r}
library(dplyr)
library(ggplot2)
```
Data Understanding
Dieser Abschnitt dient dazu, die vorhandenen Daten zu verstehen und zu interpretieren.
Zunächst wird die Summary des Trainingdatensatzes betrachtet:

```{r}
summary(training)
```
Danach wird geprüft, ob die angegebenen Datentypen auch zu den Werten der Daten passen.
```{r}
head(training)
```

Die Spalten, die den Preis enthalten, sind falsch dargestellt und müssen in "double" umgewandelt werden. Daher wird zuerst geschaut, ob nicht konvertierbare Einträge vorhanden sind:
```{r}

filteredData <- training %>%
  filter(MMRAcquisitionAuctionAveragePrice != "NULL")%>%
  filter(MMRAcquisitionAuctionCleanPrice != "NULL")%>%
  filter(MMRAcquisitionRetailAveragePrice != "NULL")%>%
  filter(MMRAcquisitonRetailCleanPrice != "NULL")%>%
  filter(MMRCurrentAuctionAveragePrice != "NULL")%>%
  filter(MMRCurrentAuctionCleanPrice != "NULL")%>%
  filter(MMRCurrentRetailAveragePrice != "NULL")%>%
  filter(MMRCurrentRetailCleanPrice != "NULL")
  
```
Durch diese Filterung fallen 315 Datensätze weg, was im Verhältnis zu dem großen Datensatz kaum Auswirkungen hat.
Nun können wir die Spalten umwandeln.

```{r}
filteredData$MMRAcquisitionAuctionAveragePrice <- as.numeric(as.character(filteredData$MMRAcquisitionAuctionAveragePrice))
filteredData$MMRAcquisitionAuctionCleanPrice <- as.numeric(as.character(filteredData$MMRAcquisitionAuctionCleanPrice))
filteredData$MMRAcquisitionRetailAveragePrice <- as.numeric(as.character(filteredData$MMRAcquisitionRetailAveragePrice))
filteredData$MMRAcquisitonRetailCleanPrice <- as.numeric(as.character(filteredData$MMRAcquisitonRetailCleanPrice))
filteredData$MMRCurrentAuctionAveragePrice <- as.numeric(as.character(filteredData$MMRCurrentAuctionAveragePrice))
filteredData$MMRCurrentAuctionCleanPrice <- as.numeric(as.character(filteredData$MMRCurrentAuctionCleanPrice))
filteredData$MMRCurrentRetailAveragePrice <- as.numeric(as.character(filteredData$MMRCurrentRetailAveragePrice))
filteredData$MMRCurrentRetailCleanPrice <- as.numeric(as.character(filteredData$MMRCurrentRetailCleanPrice))


```

Nach Umwandlung erneut Summary aufrufen:

```{r}
summary(filteredData)
```
Nach der Umwandlung sind die Zahlen nun richtig dargestellt.

Beim Betrachten der Werte kommt folgende Vermutung: 
Datensatz im Hinblick auf das Attribut "IsBadBuy" nicht balanciert. Überprüfe mit Hilfe eines einfachen Plots:
```{r}
groupedByBad <- filteredData %>%
  select(1,2)
groupedByBad <- groupedByBad %>%
  count(IsBadBuy)

ggplot(data = groupedByBad, mapping=aes(x=IsBadBuy,y=n))+
  geom_bar(stat='identity')
head(groupedByBad)
```

Im Weiteren wird die Verteilung des Alters der Fahrzeuge betrachtet:

```{r}
groupedByAge <- filteredData %>%
  select(1,6)%>%
  count(VehicleAge)
ggplot(data = groupedByAge, mapping=aes(x=VehicleAge,y=n))+
  geom_bar(stat='identity')
```
Hierbei handelt es sich um eine nach links verlagerte Gleichverteilung. Interessanter wird hier der Anteil der Fahrzeuge sein, die als Fehlkauf markiert wurden:

```{r}
groupedByAgeAndIsBad <- filteredData %>%
  select(1,2,6)%>%
  group_by(IsBadBuy, VehicleAge)%>%
  count(VehicleAge)


ggplot(groupedByAgeAndIsBad, aes(fill=IsBadBuy, y=n, x=VehicleAge)) + 
    geom_bar(position="dodge", stat="identity")

```
Um diesen Anstieg der "Kicks" im Alter besser darzustellen, folgt ein Graph, der das Verhältnis darstellt:

```{r}
groupedByAgeAndIsBad <- groupedByAgeAndIsBad %>%
  group_by(VehicleAge)%>%
  mutate(n2 = sum(n))%>%
  group_by(VehicleAge, add = TRUE)%>%
  mutate(percentageBadBuy=round(100*n/n2,2))%>%
  filter(IsBadBuy == 1)

ggplot(groupedByAgeAndIsBad, aes(x = VehicleAge, y = percentageBadBuy))+
  geom_line()

```
Je älter ein Fahrzeug also ist, umso wahrscheinlicher ist, dass es ein Fehlkauf ist.

Weiter wird untersucht, ob die Laufleistung im Bezug auf das Fahrzeugalter eine ähnliche Entwicklung erfährt:

```{r}
groupedByOdo <- filteredData %>%
  select(1,2,6,15)%>%
  group_by(IsBadBuy, VehicleAge)%>%
  summarize(VehOdo2 = mean(VehOdo))
ggplot(groupedByOdo, aes(x= VehicleAge, y=VehOdo2, group = IsBadBuy, color = IsBadBuy))+
  geom_line()


```
In diesem Graphen wird deutlich, dass die durchschnittliche Laufleistung bei Fehlkäufen gerade bei älteren Fahrzeugen leicht höher liegt.

Weiter wird der überprüft, ob gewisse Automarken einen höheren Anteil an Fehlkäufen haben als andere.

```{r}
groupedByMake <- filteredData %>%
  select(1,2,7)%>%
  group_by(IsBadBuy, Make)%>%
  count(Make)%>%
  group_by(Make)%>%
  mutate(n2 = sum(n))%>%
  group_by(Make, add = TRUE)%>%
  mutate(percentageBadBuy=round(100*n/n2,2))%>%
  filter(IsBadBuy == 1)

ggplot(groupedByMake, aes(x = Make, y = percentageBadBuy))+
  geom_bar(stat="identity")
```
Da Graph sehr unübersichtlich sortiere nach größtem Anteil und plotte nur die ersten 10:

```{r}
groupedByMake <- groupedByMake[with(groupedByMake, order(-percentageBadBuy)),]
groupedByMakeSmall <- groupedByMake[1:10,]
ggplot(groupedByMakeSmall, aes(x = reorder(Make, -percentageBadBuy), y = percentageBadBuy))+
  geom_bar(stat="identity")
```
Ebenfalls werden die 10 kleinsten betrachtet:

```{r}
groupedByMake <- groupedByMake[with(groupedByMake, order(percentageBadBuy)),]
groupedByMakeSmall <- groupedByMake[1:10,]
ggplot(groupedByMakeSmall, aes(x = reorder(Make, percentageBadBuy), y = percentageBadBuy))+
  geom_bar(stat="identity")
```
Problem bei dieser Darstellung ist, dass zum Beispiel der Hersteller Plymouth zwar einen hohen Anteil an schlechten Fahrzeugen hat, allerdings sind nur zwei Datensätze zu diesem Hersteller vorhanden, sodass diese Grafik nicht aussagekräftig genug ist. Daher müssen die absoluten Zahlen der Hersteller betrachtet werden, um solche kleinen Datensätze zu berücksichtigen.


```{r}
groupedByMake <- filteredData %>%
  select(1,2,7)%>%
  group_by(IsBadBuy, Make)%>%
  count(Make)


summary(groupedByMake)
```
#------------- Weiter gucken mit schlechter Verteilung mit Anzahl pro Marke




